
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WWFM-DSAP Public Records Heatmap</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            background-color: #111;
        }

        .heatmap {
            display: grid;
            grid-template-rows: repeat(6, 1fr);
            grid-template-columns: repeat(68, 1fr);
            width: 100vw;
            height: calc(100vh / 3 - 10px);
            margin-bottom: 10px;
        }

        .heatmap_cell { /* Renamed cell class */
            border: 1px solid black;
            position: relative;
            background-size: cover;
            background-position: center;
        }

        .dark-red {
            background-color: darkslategrey;
            border: 1px solid darkturquoise;
        }

        .dark-green {
            background-color: green;
            border: 1px solid green;
        }

        .light-green {
            border: 1px solid orange;
        }

        .key {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 21px;
            color: white;
            z-index: 100;
            font-size: 1.8em;
            border: 1px solid white;
            min-height: 143px;
            min-width: 138px;
            width: 14vw;
            height: 10.5vw;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px;
            border-radius: 5px;
            font-size: 0.8em;
            visibility: hidden;
            z-index: 101;
            transition: visibility 0s linear 0.5s, opacity 0.5s linear;
            opacity: 0;
            width: 200px;
        }

        .heatmap_cell:hover .tooltip,
        .heatmap_cell:focus .tooltip {
            visibility: visible;
            opacity: 1;
            transition-delay: 0s;
        }
    </style>
</head>
<body>
    <div class="key">
        <p><span style="color: orange;">&#9632;</span> Negotiating</p>
        <p><span style="color: green;">&#9632;</span> Licensed</p>
    </div>
    <div class="heatmap" id="heatmap1"></div>
    <div class="heatmap" id="heatmap2"></div>
    <div class="heatmap" id="heatmap3"></div>
    <script>
        async function fetchData() {
            try {
                const response = await fetch('data.json');
                const data = await response.json();
                return data.countries;
            } catch (error) {
                console.error('Error fetching data:', error);
                return null;
            }
        }

        async function fetchCountryData(filename) {
            try {
                const response = await fetch(filename);
                const data = await response.json();
                return data;
            } catch (error) {
                console.error(`Error fetching data from ${filename}:`, error);
                return null;
            }
        }

        function extractUIDs(data) {
            const uids = [];

            function recurse(obj) {
                if (obj.uid) {
                    uids.push(obj.uid);
                }
                for (const key in obj) {
                    if (typeof obj[key] === 'object') {
                        recurse(obj[key]);
                    }
                }
            }

            recurse(data);
            return uids;
        }

        function countUIDs(uids) {
            const counts = new Map();

            for (const uid of uids) {
                const parts = uid.split('-');

                for (let i = 1; i <= parts.length; i++) {
                    const prefix = parts.slice(0, i).join('-');
                    counts.set(prefix, (counts.get(prefix) || 0) + 1);
                }
            }

            return counts;
        }

        function getCellColor(count) {
            if (count >= 10) {
                return 'light-green';
            } else if (count > 0) {
                return 'dark-green';
            } else {
                return 'dark-red';
            }
        }

        function createHeatmap(counts, countryCodes, divisionNames, existingUIDs, heatmapId) {
            const heatmap = document.getElementById(heatmapId);

            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 68; col++) {
                    const originalCol = (heatmapId === 'heatmap1' ? col : (heatmapId === 'heatmap2' ? col + 68 : col + 136));
                    const prefix = `${String(originalCol).padStart(3, '0')}-${String(row).padStart(4, '0')}`;
                    const count = counts.get(prefix) || 0;
                    const cellColor = getCellColor(count);

                    const cell = document.createElement('div');
                    cell.className = `heatmap_cell ${cellColor}`; // Use renamed class

                    // Get the country code for the current column
                    const countryCode = countryCodes[originalCol];

                    if (row === 0 && countryCode) { // Apply flag only to the first row
                        cell.style.backgroundImage = `url('flags/${countryCode.toLowerCase()}.png')`; // Assuming flag images are in a 'flags' folder
                    }

                    const tooltip = document.createElement('div');
                    tooltip.className = 'tooltip';
                    const countryName = countryCodes[originalCol] ? `(${countryCode}) ${countryCodes[originalCol]}` : `Country no.: ${originalCol + 1}`;
                    const divisionLevel = `Level ${row}`;
                    const uidFormat = `${prefix}-00000-000000-0000000-00000000`;
                    const filepath = `./en/${uidFormat}`;

                    if (existingUIDs.includes(uidFormat)) {
                        tooltip.innerHTML = `${countryName}<br>${divisionLevel}<br><a href="${filepath}" target="_blank" style="color: white;">View records</a>`;
                    } else {
                        tooltip.innerHTML = `${countryName}<br>${divisionLevel}<br><span style="color: grey;">View records</span>`;
                    }

                    cell.appendChild(tooltip);
                    heatmap.appendChild(cell);
                }
            }
        }

        async function init() {
            const countryData = await fetchData();

            if (!countryData) {
                return;
            }

            let allUIDs = [];
            let countryCodes = [];
            let divisionNames = ["Level 0", "Level 1", "Level 2", "Level 3", "Level 4", "Level 5"];

            for (const [index, country] of countryData.entries()) {
                const data = await fetchCountryData(country.filename);

                if (data) {
                    const uids = extractUIDs(data);
                    allUIDs = allUIDs.concat(uids);
                    // Assuming countryCodes are available in the countryData
                    countryCodes[index] = country.code;
                }
            }

            const counts = countUIDs(allUIDs);
            createHeatmap(counts, countryCodes, divisionNames, allUIDs, 'heatmap1');
            createHeatmap(counts, countryCodes, divisionNames, allUIDs, 'heatmap2');
            createHeatmap(counts, countryCodes, divisionNames, allUIDs, 'heatmap3');
        }

        init();
    </script>
</body>
</html>
